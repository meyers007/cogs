{% extends "common.html" %}
{% block content %}
<style>
/* Wakeword Detection Interface */
* {
    box-sizing: border-box;
}

body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%);
    height: 100vh;
    overflow: hidden;
}

.wakeword-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    max-width: 1200px;
    margin: 0 auto;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
}

.header {
    background: linear-gradient(135deg, #A855F7 0%, #7C3AED 100%);
    color: white;
    padding: 20px;
    text-align: center;
    font-size: 28px;
    font-weight: 600;
    letter-spacing: 1px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.main-content {
    display: flex;
    flex: 1;
    overflow: hidden;
}

.control-panel {
    width: 350px;
    background: #f8f9fa;
    padding: 20px;
    border-right: 2px solid #e0e0e0;
    overflow-y: auto;
}

.detection-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: white;
    position: relative;
}

.wakeword-status {
    width: 300px;
    height: 300px;
    border-radius: 50%;
    background: linear-gradient(145deg, #f0f0f0, #ffffff);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    position: relative;
    transition: all 0.3s ease;
    margin-bottom: 30px;
}

.wakeword-status.listening {
    background: linear-gradient(145deg, #A855F7, #8B5CF6);
    animation: pulse 2s infinite;
}

.wakeword-status.detected {
    background: linear-gradient(145deg, #C084FC, #A855F7);
    animation: glow 0.5s ease-in-out;
}

@keyframes pulse {
    0% { transform: scale(1); box-shadow: 0 20px 40px rgba(168, 85, 247, 0.3); }
    50% { transform: scale(1.05); box-shadow: 0 25px 50px rgba(168, 85, 247, 0.5); }
    100% { transform: scale(1); box-shadow: 0 20px 40px rgba(168, 85, 247, 0.3); }
}

@keyframes glow {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.status-icon {
    font-size: 80px;
    color: #6c757d;
    transition: all 0.3s ease;
}

.wakeword-status.listening .status-icon {
    color: white;
}

.wakeword-status.detected .status-icon {
    color: white;
}

.status-text {
    font-size: 24px;
    font-weight: 600;
    color: #A855F7;
    text-align: center;
    margin-bottom: 10px;
}

.confidence-score {
    font-size: 18px;
    color: #6c757d;
    text-align: center;
}

.control-section {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.control-section h3 {
    margin: 0 0 15px 0;
    color: #A855F7;
    font-size: 18px;
    border-bottom: 2px solid #A855F7;
    padding-bottom: 8px;
}

.btn {
    background: linear-gradient(135deg, #A855F7, #C084FC);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s ease;
    width: 100%;
    margin-bottom: 10px;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(168, 85, 247, 0.3);
}

.btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
}

.btn.danger {
    background: linear-gradient(135deg, #dc3545, #c82333);
}

.btn.success {
    background: linear-gradient(135deg, #28a745, #20c997);
}

.settings-group {
    margin-bottom: 15px;
}

.settings-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #A855F7;
}

.settings-group input, .settings-group select {
    width: 100%;
    padding: 8px 12px;
    border: 2px solid #e0e0e0;
    border-radius: 5px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.settings-group input:focus, .settings-group select:focus {
    outline: none;
    border-color: #A855F7;
}

.log-area {
    background: #2d3748;
    color: #e2e8f0;
    padding: 15px;
    border-radius: 5px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    height: 200px;
    overflow-y: auto;
    margin-top: 10px;
}

.wakeword-variants {
    background: #F3E8FF;
    border-left: 4px solid #A855F7;
    padding: 15px;
    margin: 15px 0;
    border-radius: 0 5px 5px 0;
}

.wakeword-variants h4 {
    margin: 0 0 10px 0;
    color: #7C3AED;
}

.variant-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.variant-list li {
    background: white;
    padding: 8px 12px;
    margin: 5px 0;
    border-radius: 15px;
    font-weight: 500;
    color: #A855F7;
}

.audio-visualizer {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 3px;
    align-items: end;
}

.bar {
    width: 4px;
    background: #A855F7;
    border-radius: 2px;
    transition: height 0.1s ease;
}

.error-message {
    background: #f8d7da;
    color: #721c24;
    padding: 15px;
    border-radius: 5px;
    margin: 10px 0;
    border-left: 4px solid #dc3545;
    display: none;
}

.success-message {
    background: #d4edda;
    color: #155724;
    padding: 15px;
    border-radius: 5px;
    margin: 10px 0;
    border-left: 4px solid #28a745;
    display: none;
}
</style>

<div class="wakeword-container">
    <div class="header">
        üé§ Sage Wakeword Detection Demo
    </div>
    
    <div class="main-content">
        <!-- Control Panel -->
        <div class="control-panel">
            <div class="control-section">
                <h3>üéØ Detection Control</h3>
                <button class="btn" id="startBtn" onclick="startDetection()">Start Listening</button>
                <button class="btn danger" id="stopBtn" onclick="stopDetection()" disabled>Stop Listening</button>
                <button class="btn success" id="testBtn" onclick="testWakeword()">Test Detection</button>
            </div>
            
            <div class="control-section">
                <h3>‚öôÔ∏è Settings</h3>
                <div class="settings-group">
                    <label for="threshold">Detection Threshold</label>
                    <input type="range" id="threshold" min="0.1" max="1.0" step="0.1" value="0.5" onchange="updateThreshold()">
                    <span id="thresholdValue">0.5</span>
                </div>
                
                <div class="settings-group">
                    <label for="model">Wakeword Model</label>
                    <select id="model" onchange="changeModel()">
                        <option value="sage">Sage (Custom)</option>
                        <option value="hey_jarvis">Hey Jarvis</option>
                        <option value="alexa">Alexa</option>
                    </select>
                </div>
                
                <div class="settings-group">
                    <label for="sensitivity">Microphone Sensitivity</label>
                    <input type="range" id="sensitivity" min="0.1" max="2.0" step="0.1" value="1.0" onchange="updateSensitivity()">
                    <span id="sensitivityValue">1.0</span>
                </div>
            </div>
            
            <div class="wakeword-variants">
                <h4>üó£Ô∏è Supported Wake Phrases</h4>
                <ul class="variant-list">
                    <li>"Hey Sage"</li>
                    <li>"Sage"</li>
                    <li>"Hey Saige"</li>
                    <li>"Saige"</li>
                    <li>"Sage Assistant"</li>
                </ul>
            </div>
            
            <div class="control-section">
                <h3>üìä Statistics</h3>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Detections:</span>
                    <span id="detectionCount">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>False Positives:</span>
                    <span id="falsePositiveCount">0</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Accuracy:</span>
                    <span id="accuracy">100%</span>
                </div>
            </div>
        </div>
        
        <!-- Detection Area -->
        <div class="detection-area">
            <div class="wakeword-status" id="wakewordStatus">
                <div class="status-icon" id="statusIcon">üé§</div>
            </div>
            
            <div class="status-text" id="statusText">Ready to Listen</div>
            <div class="confidence-score" id="confidenceScore">Confidence: 0%</div>
            
            <!-- Audio Visualizer -->
            <div class="audio-visualizer" id="audioVisualizer">
                <!-- Bars will be generated by JavaScript -->
            </div>
            
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
        </div>
    </div>
    
    <!-- Log Area -->
    <div class="control-section" style="margin: 20px;">
        <h3>üìù Detection Log</h3>
        <div class="log-area" id="logArea">
            <div>[INFO] Wakeword detection system initialized</div>
            <div>[INFO] Ready to start listening for 'Sage' variants</div>
        </div>
    </div>
</div>

<script>
// Global variables
let isListening = false;
let audioContext = null;
let mediaStream = null;
let processor = null;
let detectionCount = 0;
let falsePositiveCount = 0;
let currentThreshold = 0.5;
let currentModel = 'sage';
let audioData = [];

// Initialize audio visualizer
function initializeVisualizer() {
    const visualizer = document.getElementById('audioVisualizer');
    for (let i = 0; i < 20; i++) {
        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.height = '5px';
        visualizer.appendChild(bar);
    }
}

// Start wakeword detection
async function startDetection() {
    try {
        // Request microphone access
        mediaStream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                sampleRate: 16000,
                channelCount: 1,
                echoCancellation: true,
                noiseSuppression: true
            }
        });
        
        // Initialize Web Audio API
        audioContext = new (window.AudioContext || window.webkitAudioContext)({
            sampleRate: 16000
        });
        
        const source = audioContext.createMediaStreamSource(mediaStream);
        processor = audioContext.createScriptProcessor(4096, 1, 1);
        
        processor.onaudioprocess = function(event) {
            if (isListening) {
                const inputData = event.inputBuffer.getChannelData(0);
                processAudioData(inputData);
                updateVisualizer(inputData);
            }
        };
        
        source.connect(processor);
        processor.connect(audioContext.destination);
        
        isListening = true;
        updateUI();
        logMessage('[INFO] Started listening for wakeword');
        showSuccess('Microphone access granted. Listening for "Sage"...');
        
    } catch (error) {
        console.error('Error starting detection:', error);
        showError('Failed to access microphone. Please check permissions.');
        logMessage(`[ERROR] ${error.message}`);
    }
}

// Stop wakeword detection
function stopDetection() {
    isListening = false;
    
    if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
    }
    
    if (processor) {
        processor.disconnect();
        processor = null;
    }
    
    if (audioContext) {
        audioContext.close();
        audioContext = null;
    }
    
    updateUI();
    logMessage('[INFO] Stopped listening for wakeword');
    showSuccess('Detection stopped');
}

// Process audio data for wakeword detection
function processAudioData(audioData) {
    // Convert Float32Array to 16-bit PCM
    const pcmData = new Int16Array(audioData.length);
    for (let i = 0; i < audioData.length; i++) {
        pcmData[i] = Math.max(-32768, Math.min(32767, audioData[i] * 32768));
    }
    
    // Send to backend for wakeword detection
    detectWakeword(pcmData);
}

// Send audio data to backend for wakeword detection
async function detectWakeword(audioData) {
    try {
        const response = await fetch('/api/wakeword/detect', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                audio_data: Array.from(audioData),
                model: currentModel,
                threshold: currentThreshold
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.detected) {
                handleWakewordDetected(result.confidence, result.phrase);
            }
            updateConfidenceScore(result.confidence || 0);
        }
        
    } catch (error) {
        console.error('Wakeword detection error:', error);
        // Fallback: simulate detection for demo
        simulateDetection(audioData);
    }
}

// Simulate wakeword detection for demo purposes
function simulateDetection(audioData) {
    // Simple energy-based detection simulation
    const energy = audioData.reduce((sum, sample) => sum + Math.abs(sample), 0) / audioData.length;
    const normalizedEnergy = Math.min(1.0, energy / 1000);
    
    updateConfidenceScore(normalizedEnergy);
    
    // Random detection for demo (very low probability)
    if (Math.random() < 0.001 && normalizedEnergy > currentThreshold) {
        handleWakewordDetected(normalizedEnergy, 'Sage (simulated)');
    }
}

// Handle wakeword detection
function handleWakewordDetected(confidence, phrase) {
    detectionCount++;
    updateStatistics();
    
    const statusElement = document.getElementById('wakewordStatus');
    const iconElement = document.getElementById('statusIcon');
    const textElement = document.getElementById('statusText');
    
    // Visual feedback
    statusElement.classList.add('detected');
    iconElement.textContent = '‚úÖ';
    textElement.textContent = `Detected: "${phrase}"`;
    
    logMessage(`[DETECTED] "${phrase}" (confidence: ${(confidence * 100).toFixed(1)}%)`);
    showSuccess(`Wakeword detected: "${phrase}" with ${(confidence * 100).toFixed(1)}% confidence`);
    
    // Reset after 2 seconds
    setTimeout(() => {
        statusElement.classList.remove('detected');
        iconElement.textContent = 'üé§';
        textElement.textContent = 'Listening...';
    }, 2000);
}

// Update audio visualizer
function updateVisualizer(audioData) {
    const bars = document.querySelectorAll('.bar');
    const bufferLength = audioData.length;
    const barCount = bars.length;
    const samplesPerBar = Math.floor(bufferLength / barCount);
    
    for (let i = 0; i < barCount; i++) {
        let sum = 0;
        for (let j = 0; j < samplesPerBar; j++) {
            sum += Math.abs(audioData[i * samplesPerBar + j]);
        }
        const average = sum / samplesPerBar;
        const height = Math.max(5, Math.min(50, average * 200));
        bars[i].style.height = height + 'px';
    }
}

// Update confidence score display
function updateConfidenceScore(confidence) {
    document.getElementById('confidenceScore').textContent = 
        `Confidence: ${(confidence * 100).toFixed(1)}%`;
}

// Update UI based on listening state
function updateUI() {
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusElement = document.getElementById('wakewordStatus');
    const iconElement = document.getElementById('statusIcon');
    const textElement = document.getElementById('statusText');
    
    if (isListening) {
        startBtn.disabled = true;
        stopBtn.disabled = false;
        statusElement.classList.add('listening');
        iconElement.textContent = 'üé§';
        textElement.textContent = 'Listening...';
    } else {
        startBtn.disabled = false;
        stopBtn.disabled = true;
        statusElement.classList.remove('listening', 'detected');
        iconElement.textContent = 'üé§';
        textElement.textContent = 'Ready to Listen';
    }
}

// Test wakeword detection
function testWakeword() {
    if (!isListening) {
        showError('Please start listening first');
        return;
    }
    
    // Simulate a detection
    handleWakewordDetected(0.95, 'Sage (test)');
    logMessage('[TEST] Simulated wakeword detection');
}

// Update threshold
function updateThreshold() {
    currentThreshold = parseFloat(document.getElementById('threshold').value);
    document.getElementById('thresholdValue').textContent = currentThreshold.toFixed(1);
    logMessage(`[SETTINGS] Threshold updated to ${currentThreshold}`);
}

// Update sensitivity
function updateSensitivity() {
    const sensitivity = parseFloat(document.getElementById('sensitivity').value);
    document.getElementById('sensitivityValue').textContent = sensitivity.toFixed(1);
    logMessage(`[SETTINGS] Sensitivity updated to ${sensitivity}`);
}

// Change model
function changeModel() {
    currentModel = document.getElementById('model').value;
    logMessage(`[SETTINGS] Model changed to ${currentModel}`);
}

// Update statistics
function updateStatistics() {
    document.getElementById('detectionCount').textContent = detectionCount;
    document.getElementById('falsePositiveCount').textContent = falsePositiveCount;
    
    const total = detectionCount + falsePositiveCount;
    const accuracy = total > 0 ? ((detectionCount / total) * 100).toFixed(1) : 100;
    document.getElementById('accuracy').textContent = accuracy + '%';
}

// Log message
function logMessage(message) {
    const logArea = document.getElementById('logArea');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.textContent = `[${timestamp}] ${message}`;
    logArea.appendChild(logEntry);
    logArea.scrollTop = logArea.scrollHeight;
}

// Show error message
function showError(message) {
    const errorElement = document.getElementById('errorMessage');
    errorElement.textContent = message;
    errorElement.style.display = 'block';
    setTimeout(() => {
        errorElement.style.display = 'none';
    }, 5000);
}

// Show success message
function showSuccess(message) {
    const successElement = document.getElementById('successMessage');
    successElement.textContent = message;
    successElement.style.display = 'block';
    setTimeout(() => {
        successElement.style.display = 'none';
    }, 3000);
}

// Utility function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    initializeVisualizer();
    updateUI();
    logMessage('[INFO] Wakeword detection interface loaded');
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (isListening) {
        stopDetection();
    }
});
</script>
{% endblock %}
